"use strict";angular.module("factoryng").factory("PouchyngCommon",["$q","$timeout","Yng","yngutils",function(a,b,c,d){return function(b,e,f){function g(a){a&&405!==a.status&&k.yng.error(a)}function h(){k.yng.emit("uptodate")}function i(a){return function(){return k.map().then(function(){return k.yng.sortIfNeeded(),k.yng.bindModel(k.yng.scope).then(a.resolve)})}}function j(){return k.db.info().then(function(b){var c=a.defer();k.changes=k.db.changes({since:b.update_seq,live:!0}),k.registerListeners();var d={live:!0},e=k.yng.url+"/"+k.yng.name;return k.to=k.db.replicate.to(e,d,g),k.from=k.db.replicate.from(e,d,g).once("uptodate",i(c)).on("uptodate",h).once("error",i(c)).on("complete",h),c.promise})}var k=this;this.yng=new c(b,e,f),this.db=null,this.to=null,this.from=null,this.changes=null,this.provider=function(){return k.db},this.bind=function(a){return k.db?k.yng.rebindModel(a):(k.db=new PouchDB(k.yng.name+"_"+k.yng.nextId()),k.db.setMaxListeners(20),k.yng.scope=a,k.db.on("error",k.yng.error),j())},this.cancel=function(){k.changes&&k.changes.cancel(),k.to&&k.to.cancel(),k.from&&k.from.cancel()},this.destroy=function(b){k.cancel();var c=a.defer();this.db.on("destroyed",function(){c.resolve()});var d=[k.db.destroy(),c.promise];if(!b){var e=new PouchDB(k.yng.url+"/"+k.yng.name),f=a.defer();e.on("destroyed",function(){f.resolve()}),d.push(e.destroy(),f.promise)}return a.all(d).then(function(){return k.yng.destroy()})},this.copyApi=function(a){k.yng.copyApi(a);var b=["provider","bind","destroy"];d.copyFns(b,k,a)}}}]),angular.module("factoryng").factory("DeltaPouchyng",["$q","$timeout","Yng","yngutils","PouchyngCommon",function(a,b,c,d,e){return function(a,c,f){function g(a){delete a._rev,j.yng.createDoc(a)}function h(a){delete a._rev;var b=j.yng.get(a.$id),c=j.db.merge(b,a);c.$priority!==b.$priority?j.yng.moveDoc(c):j.yng.updateDoc(c)}function i(a){j.yng.removeDoc(a)}var j=new e(a,c,f);j.copyApi(this),j.map=function(){return j.db.all().then(function(a){return b(function(){d.forEach(a,function(a){delete a._rev,j.yng.push(a)})})})},j.registerListeners=function(){var a=i;j.db.deltaInit(),j.db.delta.on("create",g).on("update",h).on("delete",a)},this.create=function(a){return j.yng.setPriorityIfNeeded(a),j.db.save(a).then(function(b){return a.$id=b.$id,j.yng.push(a),a})},this.update=function(a){var b=j.yng.get(a.$id);return j.db.saveChanges(b,a).then(function(c){var d=j.db.merge(b,c);return j.yng.set(d),a})},this.remove=function(a){return j.db.delete(a).then(function(a){return j.yng.remove(a.$id)})},this.setPriority=function(a,b){var c=j.yng.toId(a),e=j.yng.get(c),f=d.clone(e);return f.$priority=b,j.db.saveChanges(e,f).then(function(){return j.yng.moveDoc(f),e})},this.cleanup=function(){return j.db.cleanup()}}}]);